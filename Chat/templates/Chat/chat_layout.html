{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/chat_layout.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <title>{% block title %}{% endblock %}</title>
</head>
<body>
    <div class="wrapper">

        <nav class="sidebar active">

            <header class="sidebarCollapse">
                <i class="bi bi-chat-left-fill logo"></i>
                <div class="service-name">Communicator</div>
            </header>
            {% for message in messages %}
            <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            <div class="contact_list">
                {% for user in users %}
                <div class="contact" data-user-id="{{user.id}}">
                    <img src="{% get_media_prefix %}{{ user.profilePicture }}" alt="No image">
                    <div class="contact_info">
                        <div class="contact_name">{{user.username}}</div>
                        <div class="contact_message">Hello</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="myprofile">
                logged in as {{ request.user.username }}
            </div>

        </nav>

        <div class="content" data-user-id="1">

            <header class="contact_bar">
                <div class="sidebarCollapse">
                    <i class="bi bi-chat-left-fill logo"></i>
                </div>
                <div class="name">
                    nickname
                </div>
            </header>

            <main>
                <div id="message_area" class="container-fluid">
                    <div class="message_wrapper">
                        <img src="https://images.pexels.com/photos/13350289/pexels-photo-13350289.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"></img>
                        <div class="message_group">
                            <div class="message">
                                Hello there
                            </div>
                            <div class="message">
                                <div class="text">Hello there name 2eee</div>
                            </div>
                        </div>
                    </div>

                    <div class="message_wrapper you">
                        <div class="message_group">
                            <div class="message">
                                <div class="text">Hi</div>
                            </div>
                            <div class="message">
                                <div class="text">How are you? I am well today</div>
                            </div>
                            <div class="message">
                                <div class="text">How are you? I am today</div>
                            </div>
                        </div>
                    </div>                    
                    
                    <div class="message_wrapper">
                        <img src="https://images.pexels.com/photos/13350289/pexels-photo-13350289.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"></img>
                        <div class="message_group">
                            <div class="message">
                                <div class="text">Hello there name 2eee</div>
                            </div>
                        </div>
                    </div>

                    <div class="message_wrapper you">
                        <div class="message_group">
                            <div class="message">
                                <div class="text">Hi</div>
                            </div>
                            <div class="message">
                                <div class="text">How are you? I am well today</div>
                            </div>
                            <div class="message">
                                <div class="text">How are you? I am today</div>
                            </div>
                        </div>
                    </div>
                    <div class="message_wrapper">
                        <img src="https://images.pexels.com/photos/13350289/pexels-photo-13350289.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"></img>
                        <div class="message_group">
                            <div class="message">
                                Hello there
                            </div>
                            <div class="message">
                                <div class="text">Hello there name 2eeeHello there name 2eeeHello there name 2eeeHello there name 2eeeHello there name 2eee</div>
                            </div>
                            <div class="message">
                                <div class="text">Hello</div>
                            </div>
                        </div>
                    </div>

                    <div class="message_wrapper you" data-username="test">
                        <div class="message_group">
                            <div class="message">
                                <div class="text">How are you? I Hello there name 2eeeHello there name 2eeeHello there name 2eeeHello there name 2eeeam today last</div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <form id="new_message">
                    <textarea placeholder="Aa" name="message" maxlength="256"></textarea>
                    <button type="submit" class=""><i class="bi bi-send"></i></button>
                </form>
            </main>

        </div>
    </div>

    </div>
    {{ request.user.username|json_script:"username" }}
    <script>
        const username = JSON.parse(document.getElementById('username').innerText)
        const message_area = document.getElementById('message_area')
        Array.from(document.getElementsByClassName("contact")).forEach((element) => {
            element.addEventListener('click', () => {
                alert(element.getAttribute('data-user-id'))
            })
        });
        Array.from(document.getElementsByClassName("sidebarCollapse")).forEach((element) => {
            element.addEventListener('click', () => {
                document.getElementsByClassName("sidebar")[0].classList.toggle('active')
                document.getElementsByClassName("content")[0].classList.toggle('active')
                message_area.lastElementChild.scrollIntoView()
            })
        });

        let url = `ws://${window.location.host}/ws/chat/1/`
        const chatSocket = new WebSocket(url)
        chatSocket.onmessage = function(e){
            let data = JSON.parse(e.data)
            console.log('Data: ', data)



            if(data.type == 'chat'){
                if(message_area.lastElementChild.getAttribute('data-username') == data.username){
                    message_area.lastElementChild.getElementsByClassName('message_group')[0].innerHTML += `
                        <div class="message">
                            <div class="text">${data.message}</div>
                        </div>
                    `
                }
                else{
                    let new_message_wrapper = document.createElement('div')
                    new_message_wrapper.innerHTML = `
                        <div class='message_group'>
                            <div class="message">
                                <div class="text">${data.message}</div>
                            </div>
                        </div>`
                    new_message_wrapper.setAttribute('data-username', data.username)
                    new_message_wrapper.classList = 'message_wrapper'
                    if(data.username == username){
                        new_message_wrapper.classList.add('you')
                    }
                    else{
                        let img = document.createElement('img')
                        img.setAttribute('src', data.profilePicture)
                        new_message_wrapper.insertBefore(img, new_message_wrapper.firstChild)
                    }
                    message_area.append(new_message_wrapper)
                    message_area.lastElementChild.scrollIntoView()
                }
            }
        }

        let form = document.getElementById('new_message')
        form.addEventListener('submit', (e) => {
            e.preventDefault()
            let message = e.target.message.value
            chatSocket.send(JSON.stringify({
                'message':message
            }))
            form.reset()
        })

    </script>
</body>
</html>